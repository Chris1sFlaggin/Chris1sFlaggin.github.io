<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Ordini - PizzaDelivery</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Font Awesome per le icone -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Toastr per le notifiche -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
</head>
<body>
    <header>
        <nav class="main-nav">
            <div class="logo">
                <a href="/"><img src="/static/img/logo.png" alt="PizzaDelivery Logo"></a>
            </div>
            <ul class="nav-links">
                <li><a href="/dashboard"><i class="fas fa-chart-bar"></i> Dashboard</a></li>
                <li class="active"><a href="/orders"><i class="fas fa-clipboard-list"></i> Ordini</a></li>
                <li><a href="/map"><i class="fas fa-map-marked-alt"></i> Mappa</a></li>
                <li><a href="/settings"><i class="fas fa-cog"></i> Impostazioni</a></li>
            </ul>
            <div class="user-menu">
                <a href="/profile"><i class="fas fa-user-circle"></i> Profilo</a>
                <a href="/logout"><i class="fas fa-sign-out-alt"></i> Esci</a>
            </div>
        </nav>
    </header>

    <main class="orders-container">
        <div class="page-header">
            <h1>Gestione Ordini</h1>
            <div class="actions">
                <button id="newOrderBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Nuovo Ordine</button>
                <button id="refreshBtn" class="btn btn-secondary" onclick="loadOrders(activeFilter)">
                    <i class="fas fa-sync-alt"></i> Aggiorna
                </button>
            </div>
        </div>

        <div class="filters-container">
            <div class="filter-title">Filtra per stato:</div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="filterOrders('all')">
                    Tutti <span id="all-count" class="count-badge">0</span>
                </button>
                <button class="filter-btn" data-filter="pending" onclick="filterOrders('pending')">
                    In attesa <span id="pending-count" class="count-badge">0</span>
                </button>
                <button class="filter-btn" data-filter="in_delivery" onclick="filterOrders('in_delivery')">
                    In consegna <span id="in_delivery-count" class="count-badge">0</span>
                </button>
                <button class="filter-btn" data-filter="delivered" onclick="filterOrders('delivered')">
                    Consegnati <span id="delivered-count" class="count-badge">0</span>
                </button>
                <button class="filter-btn" data-filter="cancelled" onclick="filterOrders('cancelled')">
                    Annullati <span id="cancelled-count" class="count-badge">0</span>
                </button>
            </div>
        </div>

        <div id="ordersList" class="orders-list">
            <!-- Gli ordini verranno caricati dinamicamente qui dal JavaScript -->
            <div class="loading">Caricamento ordini...</div>
        </div>
    </main>

    <!-- Modal per il nuovo ordine -->
    <div id="newOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuovo Ordine</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="newOrderForm">
                    <div class="form-group">
                        <label for="customerName">Nome Cliente:</label>
                        <input type="text" id="customerName" name="customer_name" required>
                    </div>
                    <div class="form-group">
                        <label for="customerAddress">Indirizzo:</label>
                        <input type="text" id="customerAddress" name="address" required>
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Telefono:</label>
                        <input type="tel" id="customerPhone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="desiredDeliveryTime">Orario di Consegna Desiderato:</label>
                        <input type="datetime-local" id="desiredDeliveryTime" name="desired_delivery_time">
                        <small>Lascia vuoto per consegna il prima possibile</small>
                    </div>
                    <div class="form-group">
                        <label for="orderItems">Prodotti:</label>
                        <div id="orderItemsContainer">
                            <div class="order-item">
                                <select name="item_id[]" required>
                                    <option value="">Seleziona prodotto</option>
                                    <!-- Opzioni caricate dinamicamente -->
                                </select>
                                <input type="number" name="quantity[]" min="1" value="1" required>
                                <button type="button" class="btn-remove-item"><i class="fas fa-minus-circle"></i></button>
                            </div>
                        </div>
                        <button type="button" id="addItemBtn" class="btn-add-item">
                            <i class="fas fa-plus-circle"></i> Aggiungi prodotto
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="orderNotes">Note:</label>
                        <textarea id="orderNotes" name="notes"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Salva Ordine</button>
                        <button type="button" class="btn btn-secondary close-modal">Annulla</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal per i dettagli dell'ordine -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Dettagli Ordine</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- I dettagli dell'ordine verranno caricati qui -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="/static/js/orders.js"></script>
    <script>
            // Variabile per tenere traccia del filtro attivo
            let activeFilter = 'all';
            
            // Inizializzazione quando il documento è caricato
            document.addEventListener('DOMContentLoaded', function() {
                // Carica gli ordini
                loadOrders();
            
            // Gestione del modal per nuovo ordine
            const newOrderBtn = document.getElementById('newOrderBtn');
            const newOrderModal = document.getElementById('newOrderModal');
            const closeButtons = document.querySelectorAll('.close-modal');
            
            newOrderBtn.addEventListener('click', function() {
                newOrderModal.style.display = 'block';
                loadProducts(); // Carica i prodotti disponibili
            });
            
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    newOrderModal.style.display = 'none';
                    document.getElementById('orderDetailsModal').style.display = 'none';
                });
            });
            
            // Chiudi il modal se l'utente clicca fuori da esso
            window.addEventListener('click', function(event) {
                if (event.target === newOrderModal) {
                    newOrderModal.style.display = 'none';
                }
                if (event.target === document.getElementById('orderDetailsModal')) {
                    document.getElementById('orderDetailsModal').style.display = 'none';
                }
            });
            
            // Gestione dell'aggiunta di prodotti al form
            document.getElementById('addItemBtn').addEventListener('click', addOrderItem);
            
            // Gestione del form per nuovo ordine
            document.getElementById('newOrderForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewOrder();
            });
        });
        
        // Funzioni ausiliarie
        function loadProducts() {
            fetch('/api/products')
                .then(response => response.json())
                .then(products => {
                    const selects = document.querySelectorAll('select[name="item_id[]"]');
                    selects.forEach(select => {
                        select.innerHTML = '<option value="">Seleziona prodotto</option>';
                        products.forEach(product => {
                            const option = document.createElement('option');
                            option.value = product.id;
                            option.textContent = `${product.name} - €${product.price.toFixed(2)}`;
                            select.appendChild(option);
                        });
                    });
                })
                .catch(error => {
                    console.error('Errore nel caricamento dei prodotti:', error);
                    showNotification('Errore nel caricamento dei prodotti', 'error');
                });
        }
        
        function addOrderItem() {
            const container = document.getElementById('orderItemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'order-item';
            newItem.innerHTML = `
                <select name="item_id[]" required>
                    <option value="">Seleziona prodotto</option>
                </select>
                <input type="number" name="quantity[]" min="1" value="1" required>
                <button type="button" class="btn-remove-item"><i class="fas fa-minus-circle"></i></button>
            `;
            
            container.appendChild(newItem);
            
            // Aggiunge l'evento al pulsante di rimozione
            newItem.querySelector('.btn-remove-item').addEventListener('click', function() {
                container.removeChild(newItem);
            });
            
            // Carica i prodotti nella nuova select
            loadProducts();
        }
        
        function saveNewOrder() {
            const form = document.getElementById('newOrderForm');
            const formData = new FormData(form);
            
            const orderData = {
                customer_name: formData.get('customer_name'),
                address: formData.get('address'),
                phone: formData.get('phone'),
                notes: formData.get('notes'),
                desired_delivery_time: formData.get('desired_delivery_time') || null,
                items: []
            };
            
            const itemIds = formData.getAll('item_id[]');
            const quantities = formData.getAll('quantity[]');
            
            for (let i = 0; i < itemIds.length; i++) {
                if (itemIds[i]) {
                    orderData.items.push({
                        item_id: itemIds[i],
                        quantity: parseInt(quantities[i])
                    });
                }
            }
            
            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(order => {
                document.getElementById('newOrderModal').style.display = 'none';
                form.reset();
                loadOrders(activeFilter);
                showNotification('Ordine creato con successo', 'success');
            })
            .catch(error => {
                console.error('Errore nella creazione dell\'ordine:', error);
                showNotification('Errore nella creazione dell\'ordine', 'error');
            });
        }
        
        function filterOrders(filter) {
            activeFilter = filter;
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                if (btn.getAttribute('data-filter') === filter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            loadOrders(filter);
        }
        
        function showNotification(message, type = 'info') {
            if (typeof toastr !== 'undefined') {
                toastr[type](message);
            } else {
                alert(message);
            }
        }
        
        function showOrderDetails(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;
            
            const modalContent = document.getElementById('orderDetailsContent');
            
            const createdAt = new Date(order.created_at);
            const formattedDate = createdAt.toLocaleString('it-IT');
            
            let totalPrice = order.total_price || 0;
            if (!totalPrice && order.items && order.items.length > 0) {
                totalPrice = order.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            }
            
            let statusText = '';
            switch (order.status) {
                case 'pending': statusText = 'In attesa'; break;
                case 'in_delivery': statusText = 'In consegna'; break;
                case 'delivered': statusText = 'Consegnato'; break;
                case 'cancelled': statusText = 'Annullato'; break;
                default: statusText = order.status;
            }
            
            modalContent.innerHTML = `
                <div class="order-details-header">
                    <div class="order-id">Ordine #${order.id.substring(0, 8)}</div>
                    <div class="order-status status-${order.status}">${statusText}</div>
                </div>
                <div class="order-details-content">
                    <div class="customer-info">
                        <h3>Informazioni Cliente</h3>
                        <p><strong>Nome:</strong> ${order.customer_name}</p>
                        <p><strong>Indirizzo:</strong> ${order.address}</p>
                        <p><strong>Telefono:</strong> ${order.phone || 'Non specificato'}</p>
                    </div>
                    <div class="order-info">
                        <h3>Dettagli Ordine</h3>
                        <p><strong>Data:</strong> ${formattedDate}</p>
                        <p><strong>Totale:</strong> €${totalPrice.toFixed(2)}</p>
                        ${order.notes ? `<p><strong>Note:</strong> ${order.notes}</p>` : ''}
                    </div>
                    ${order.items && order.items.length > 0 ? `
                    <div class="order-items-details">
                        <h3>Prodotti</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Prodotto</th>
                                    <th>Quantità</th>
                                    <th>Prezzo</th>
                                    <th>Subtotale</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${order.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>€${item.price.toFixed(2)}</td>
                                    <td>€${(item.price * item.quantity).toFixed(2)}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('orderDetailsModal').style.display = 'block';
        }
    </script>
</body>
</html>